# page/sidebar_filters.py (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)

import streamlit as st
import pandas as pd
from typing import Dict, Any

# BKK District
bkk_district = [
    "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£", "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢", "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô", "‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å", "‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤", "‡∏™‡∏≤‡∏ó‡∏£", "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°",
    "‡∏î‡∏∏‡∏™‡∏¥‡∏ï", "‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠", "‡∏û‡∏ç‡∏≤‡πÑ‡∏ó", "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á", "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á", "‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢", "‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®",
    "‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á", "‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô", "‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥", "‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°", "‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å",
    "‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á", "‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î", "‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà", "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç",
    "‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô", "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á", "‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô", "‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞", "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°", "‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ", "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà", "‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°",
    "‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß", "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á", "‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á", "‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤", "‡∏ö‡∏≤‡∏á‡∏ô‡∏≤", "‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤", "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏", "‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô"
]

# üî• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà (New Place Type List)
place_types = [
    "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    "Department (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)",
    "Community (‡∏ä‡∏∏‡∏°‡∏ä‡∏ô)",
    "School (‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)",
    "Hospital (‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)"
]

# -----------------------------------------------------
# üõ†Ô∏è Render Sidebar Filters
# -----------------------------------------------------
def render_sidebar_filters(data_result: pd.DataFrame) -> Dict[str, Any]:
    st.sidebar.header('‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå')

    selected_year = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" 
    
    # --- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ (Year Filter) ---
    if 'timestamp' in data_result.columns:
        # ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Year Filter
        try:
            available_years = sorted(
                data_result['timestamp'].dt.year.unique().tolist(), 
                reverse=True
            )
            
            if available_years:
                year_list = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + available_years
                
                selected_year = st.sidebar.selectbox(
                    'üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á:',
                    year_list,
                    index=0,
                    key='year_selector'
                )

        except AttributeError:
            st.sidebar.warning("‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'timestamp' ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô datetime object ‡∏Å‡πà‡∏≠‡∏ô")
        except Exception as e:
            st.sidebar.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ: {e}")

    st.sidebar.markdown("---")

    # -------------------------------------------
    # üî• 2. ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Place Type Filter) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
    # -------------------------------------------
    selected_place_type = st.sidebar.selectbox(
        'üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:',
        place_types,
        index=0,
        key='place_type_selector'
    )

    st.sidebar.markdown("---")

    # -------------------------------------------
    # üî• 3. ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏Ç‡∏ï (District Filter)
    # -------------------------------------------
    district_list = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + bkk_district

    selected_district = st.sidebar.selectbox(
        'üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á:',
        district_list,
        index=0,
        key='district_selector'
    )

    st.sidebar.markdown("---")

    # --- Map Style Selection ---
    map_style = st.sidebar.selectbox(
        'üé® ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô',
        options=['Light', 'Dark', 'Road', 'Satellite'],
        index=0,
        key='map_style_selector'
    )

    return {
        'map_style': map_style,
        'selected_district': selected_district,
        'selected_year': selected_year,
        'selected_place_type': selected_place_type  # üî• ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    }